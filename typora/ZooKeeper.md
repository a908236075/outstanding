# 分布式过程协同技术详解

## 第一部分 概念和基础

1. 概念:开源的分布式协同服务.
2. 设计目的
   - 高性能:类似于文件的系统的命名方式,将所有路径放在内存中,可以进行快速访问.
   - 高可用:可以搭载集群以及发生故障后自动进行的主节点选举.
   - 严格的顺序性:客户机上可以实现复杂的同步.
3. 使用范围:整个ZooKeeper的服务器集群管理着**应用协作的关键数据**。ZooKeeper不适合⽤作海量数据存储。是将分布式常遇见的消息延迟导致的数据不一致,硬件服务器性能引起的假死等问题在**应用层面上完全透明化**.
4. 一般的主-从应用
   1. 主节点崩溃:不能进行任务的分配.重新选举主节点,同时避免脑裂的发生.
   2. 从节点崩溃:不能讲分配的任务正常的执行.从新分配任务,并恢复清除受到影响的过程.即源数据管理和成员关系的管理.
   3. 通信故障:崩溃监测,主节点必须具有检测从节点崩溃或失去连接的能力.
5. ZNode节点的不同类型:
   1. 持久节点:调用删除方法的时候才会删除.
   2. 临时节点:创建改节点的**客户端**崩溃或者关闭了与ZooKeeper的连接,这个节点就会删除.
   3. 有序节点:每次创建都会有一个序号和持久与临时节点组成四个节点类型.
6. 监视与通知
   1. 每次都要客户端请求获取这种轮询的方式性能不好,所以采用了服务端通知的方式.
   2. 每次通知都是触发了一个监视点.
      1. ![通过通知的方式进行znode的变化](D:\develop\GitHub\project\outstanding\typora\picture\zookeeper\通过通知的方式进行znode的变化.png)
      2. 当第三部的时候,zookeeper又有新的变化,这时客户端会获取最新的值,以保证不会错过状态的变化.
7. 版本号
   1. 每⼀个znode都有⼀个版本号，它随着每次数据变化⽽⾃增.
   2. 当调用setData和delete的时候,版本号作为参数进行传递,zookeeper会校验版本号, 如果不一致会报错.
8. ZooKeeper的架构
   1. 法定人数:是指为了使ZooKeeper⼯作必须**有效运⾏的服务器的最⼩数量**。
   2. zookeeper集群对声明回话超时负责,而不是客户端.
   3. 当尝试连接到⼀个不同的服务器时，⾮常重要的是，这个服务器的ZooKeeper状态要与最后连接的服务器的ZooKeeper**状态保持最新**。通过zkId进行区分.
   4. **锁**:为了获得⼀个锁，每个进程p尝试创建znode，名为/lock。为了避免出现死锁,我们不得不在创建这个节
      点时指定/lock为**临时节点。**